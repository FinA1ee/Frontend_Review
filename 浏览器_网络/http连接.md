### TCP基础

Http的通信都是有TCP/IP承载的 (HTTP over TCP over IP)，是因特网上的可靠连接，由IP分组传送。保证了数据正确，完整，有序。

- TCP收到Http报文数据后，将数据流分解成小数据块，将每一段封装在一个IP分组中，再通过因特网传输。

- IP地址连接到正确的计算机，端口号连接到正确的应用程序。

- TCP通过源IP地址，源端口号，目的IP地址，目的端口号识别连接。

### TCP性能时延

1. TCP连接的握手时延
2. 延迟确认算法带来的时延
3. 慢启动：防止网络过载拥塞
4. Nagle算法：发送分组前，将TCP数据绑定在一起，提高网络效率；禁用Nagle算法需要确保向TCP写入大块数据

### HTTP连接优化

- Connection首部：对首部的保护

- 串行连接事务的缺点：

  1. 每个事务需要一个新的TCP连接，握手连接和慢启动时延叠加
  2. 加载多图片时无法提前获取尺寸信息，浏览器无法显示任何内容

- 并行连接：

  1. 利用带宽打开多条TCP连接，并行执行各自的HTTP事务
  2. 在带宽有限的情况下，每个对象加载的速度都会受限制
  3. 打开多连接会消耗内存资源，引发服务器性能问题
  4. 浏览器因此会限制并行连接的数量

- 持久连接

  1. 站点局部性：大部分请求来源于同一站点
  2. 在事务结束后将连接保持在打开状态，避免建立连接阶段的时延
  3. 可能会有潜在的空闲连接，消耗服务器资源

- Keep-Alice连接

  1. Connection：Keep-Alive 请求将一条连接保持在打开状态，服务器同意则回复相同的首部。

  2. max参数：服务器期望保持此连接的事务个数；timeout参数：服务器期望保持连接活跃的时间

  3. HTTP/1.0中服务器依然默认在响应后关闭连接，需要手动设置Keep-Alive

  4. HTTP/1.1中服务器默认长连接

     ```markdown
     Connection: Keep-Alive
     Keep-Alive: max=5, timeout=120
     ```

- 管道化连接

  1. 响应到达前，将多条请求放入队列 （Pipeline）
  2. 消除等待响应带来的时延
  3. 前提：必须是持久的连接，按顺序会送HTTP响应，客户端需处理提前关闭连接的情况。





